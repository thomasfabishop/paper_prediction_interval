---
title: "Prediction Interval"
author: "T. Bishop"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up

Start: August 2013

Load packages.

```{r}
library(geoR)
library(lattice)
library(gstat)
library(moments)
library(ggplot2)
library(raster)
library(moments)
```

# Process Data

## Import
```{r}
calib=read.table("C:\\Users\\bishop\\Dropbox (Sydney Uni)\\Research\\Projects\\Pedometrics2013\\Paper_Pred_Interval\\Data\\DecOdeh00_10.txt", header=TRUE, sep="\t", dec=".")
valid=read.table("C:\\Users\\bishop\\Dropbox (Sydney Uni)\\Research\\Projects\\Pedometrics2013\\Paper_Pred_Interval\\Data\\2010pcdata.txt", header=TRUE, sep="\t", dec=".")
```

## Fix names to match

```{r}
colnames(calib)[3]<-"clay"
colnames(valid)[4]<-"slu"
colnames(valid)[5]<-"lu"
colnames(valid)[6]<-"soil"
```

## Factors for soil, lu and slu

```{r}
calib$lu<-as.factor(calib$lu)
calib$slu<-as.factor(calib$slu)
calib$soil<-as.factor(calib$soil)

valid$lu<-as.factor(valid$lu)
valid$slu<-as.factor(valid$slu)
valid$soil<-as.factor(valid$soil)
```

# Exploratory Data Analysis

## Univariate

### Calibration set

```{r}
summary(calib$clay)
length(calib$clay)
skewness(calib$clay)
sqrt(var(calib$clay))
```

```{r}
sum.df<-data.frame (
  stats=c("mean = 31.0","median = 31.5", "std. deviation = 16.5", "observations = 97", "skewness = 0.20"),
  y=c(17.5, 16.7, 15.9, 15.1, 14.3))

#tiff('hist_calib.tiff')
ggplot(calib, aes(x=clay)) + geom_histogram(binwidth=6,colour='black',fill='grey')+
  xlab("Clay (%)") +
  ylab("Frequency") +
  theme(axis.title.y = element_text(size=20))+
  theme(axis.title.y = element_text(size=12),axis.text.y  = element_text(size=10))+
  xlim(0,85)+
  ylim(0,20)+
  theme(axis.title.x = element_text(size=12),axis.text.x  = element_text(size=10))+
  geom_text(data=sum.df,aes(x=50,y=y,label=stats),size=5, hjust=0)+
  annotate("text",x=0, y=20.0, label="Calibration dataset",size=7, hjust = 0)
#   annotate("text",x=60, y=15, label="Median = 31.5",size=4)+
#   annotate("text",x=60, y=12, label="Observations = 97",size=4)
#dev.off()
```

### Validation set

```{r}
summary(valid$clay)
length(valid$clay)
skewness(valid$clay)
sqrt(var(valid$clay))
```

```{r}
sum.df<-data.frame (
  stats=c("mean = 41.7","median = 45.2", "std. deviation = 22.5", "observations = 44",  "skewness = -0.27"),
  y=c(9, 8.6, 8.2, 7.8, 7.4))

#tiff('hist_valid.tiff')
ggplot(valid, aes(x=clay)) + geom_histogram(binwidth=6,colour='black',fill='grey')+
  xlab("Clay (%)") +
  ylab("Frequency") +
  theme(axis.title.y = element_text(size=20))+
  theme(axis.title.y = element_text(size=12),axis.text.y  = element_text(size=10))+
  xlim(0,85)+
  ylim(0,10)+
  theme(axis.title.x = element_text(size=12),axis.text.x  = element_text(size=10))+
  geom_text(data=sum.df,aes(x=50,y=y,label=stats),size=5, hjust=0)+
  annotate("text",x=0, y=10.0, label="Validation dataset",size=7, hjust = 0)
#   annotate("text",x=60, y=15, label="Median = 31.5",size=4)+
#   annotate("text",x=60, y=12, label="Observations = 97",size=4)
#dev.off()
```

## Bivariate

### Soil Classes

Re-code soil class

```{r}
calib$soil.type<-ifelse(calib$soil==1, "Vertosol", "Other")

#tiff('soil_clay.tiff')
p <- ggplot(calib, aes(x=soil.type, y=clay)) + geom_boxplot() +
  xlab("Soil Type") +
  ylab("Clay (%)")+
  theme(axis.title.y = element_text(size=20))+
  ylim(0,80)+
  theme(axis.title.y = element_text(size=12),axis.text.y  = element_text(size=10))+
  theme(axis.title.x = element_text(size=12),axis.text.x  = element_text(size=10))
p
#dev.off()
```

```{r}
plot(calib$soil,calib$clay)
plot(valid$soil,valid$clay)
tapply(calib$clay,calib$soil,length)
```

Shows some difference - a candidate

### Land Use

COULD ADD label to figures
("text",x=80, y=0, label="a",size=8)

Re-code land use

```{r}
calib$land.use<-ifelse(calib$lu==1, "Dryland cropping",
                 ifelse(calib$lu==2,"Forest",
                        ifelse(calib$lu==3, "Pasture","Irrigated")))

head(calib$lu)
```

Cropping, Forest, Pasture, Irrigated

```{r}
plot(calib$lu,calib$clay)
plot(valid$lu,valid$clay)
tapply(calib$clay,calib$lu,length)
tapply(valid$clay,valid$lu,length)
```

Shows some difference - a candidate

```{r}
#tiff('luse_clay.tiff')
p <- ggplot(calib, aes(x=land.use, y=clay)) + geom_boxplot() +
  xlab("Land Use") +
  ylab("Clay (%)")+
  theme(axis.title.y = element_text(size=20))+
  ylim(0,80)+
  theme(axis.title.y = element_text(size=12),axis.text.y  = element_text(size=10))+
  theme(axis.title.x = element_text(size=12),axis.text.x  = element_text(size=10))
p
#dev.off()
```

### PCA

```{r}
skewness(calib[,7:12])
cor(calib$clay,calib[,7:12])
cor(calib$clay,calib[,7:12],method="spearman")
```

No diff with spearman

## Linear Mixed Model

### Regression with OLS

Build prediction frame

```{r}
calib<-cbind(calib$clay,calib[,1:2],calib[,5:12])
colnames(calib)[1]<-"clay"
```

Fit model

```{r}
clay.lm<-lm(clay~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6, data=calib)
summary(clay.lm)
```

Model shows some promise with adjusted r2 of 0.46.

Test model assumptions

```{r}
par(mfrow=c(2,2))
hist(rstandard(clay.lm),xlab="Standardised residuals",ylab="Frequency",main=NULL)
#skewness(clay.lm$residuals)
plot(clay.lm$fitted.values,(rstandard(clay.lm)),xlab="Fitted values",ylab="Standardised residuals")
qqnorm(rstandard(clay.lm),main=NULL,xlab="Normal quantiles",ylab="Sample quantiles")
abline(0,1)
```

Assumptions met but lets check with Wally Plots.

```{r}
library(MESS)
wallyplot(clay.lm)
qqnorm.wally <- function(x, y, ...) { qqnorm(y, ...) ; abline(a=0, b=1) }
wallyplot(clay.lm, FUN=qqnorm.wally, main="")
```



### Fit Linear Mixed Model

Create GeoR object and include OLS residuals to examine spatial structure of these to see if kriging residuals has merit.

```{r}
calib<-cbind(calib,clay.lm$residuals)
head(calib)
colnames(calib)[12] <- "residuals"
res <- as.geodata(calib,coords.col=2:3,data.col=12, covar.col=4:11)
res_var <- variog(res,option= "bin",messages = T,uvec=c(seq(0,50000,2000)))
plot(res_var, pch = 19, ylim=c(0,300),xlim=c(0,30000),col= "black", main="",xlab="distance (m)")
```

Residuals indicate short range spatail structure out to 5km so kriging of residuals shows promise.  Now create new GeoR object where response is clay.

```{r}
gcalib <- as.geodata(calib,coords.col=2:3,data.col=1, covar.col=4:11)
summary(gcalib)
plot(gcalib)
```

Define initial parameters for spatial correlation based on residual semivariogram.  Use nugget as 1st lag semivariance.  Have a few parameter combinations to find maximum likelihood and avoid local optima. First set is:

```{r}
init.par<-c(50,5000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
lmm.exp$loglik
lmm.exp$cov.pars
lmm.exp$phi
lmm.exp$nugget
```

Combination 2

```{r}
init.par<-c(25,5000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
lmm.exp$loglik
lmm.exp$cov.pars
lmm.exp$phi
lmm.exp$nugget
```

Combination 3

```{r}
init.par<-c(75,5000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
lmm.exp$loglik
lmm.exp$cov.pars
lmm.exp$phi
lmm.exp$nugget
```

Combination 4

```{r}
init.par<-c(50,10000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
lmm.exp$loglik
lmm.exp$cov.pars
lmm.exp$phi
lmm.exp$nugget
```

Combination 5

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc2+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
lmm.exp$loglik
lmm.exp$cov.pars
lmm.exp$phi
lmm.exp$nugget
```

The best combination is 5 but it is marginal.  The spatial model is best due to smaller AIC.
We plot model over residual variogram to see fit.

```{r}
plot(res_var, pch = 19, ylim=c(0,300),xlim=c(0,30000),col= "black", main="",xlab="distance (m)")
lines(lmm.exp)
```

### Variable Selection

Below is the function to perform Wald tests on the fixed effects.

```{r}
wald.test<-function(model.geostat){
fitmodel<-model.geostat
# get coefficients
coefficients <- fitmodel$beta
# get standard errors
se_error <- sqrt(diag(fitmodel$beta.var))
# get t values
t_value <- coefficients/se_error
# and probabilities
t_prob <- 2 * pt(-abs(t_value), df = (nrow(calib) -length (coefficients)))
# make pretty
coef_mat <- cbind(coefficients, se_error, t_value, t_prob)
colnames(coef_mat) <- c("Estimate", "Std.Err","t value", "Pr(>|t|)")
rownames(coef_mat) <- colnames(model.matrix(fitmodel$trend, gcalib))
return(printCoefmat(coef_mat))
}
```

We apply it to our model with all covariates.

```{r}
wald.test(lmm.exp)
```

We remove the covariate with the largest P-value which is pc2 and run again.

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc1+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
summary(lmm.exp)
wald.test(lmm.exp)
```

We remove pc1.

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~soil+lu+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
summary(lmm.exp)
wald.test(lmm.exp)
```

We remove soil.

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~lu+pc3+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
summary(lmm.exp)
wald.test(lmm.exp)
```

We remove pc3.

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~lu+pc4+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
summary(lmm.exp)
wald.test(lmm.exp)
```

We remove pc4.

```{r}
init.par<-c(50,2000)
nug.par=50
lmm.exp <- likfit(gcalib, trend= ~lu+pc5+pc6,
                  lambda=1,ini.cov.pars = init.par,fix.nugget = FALSE, nugget = nug.par, 
                  lik.method = "REML", cov.model = "exp",limits = pars.limits(phi=c(0, 50000)))
summary(lmm.exp)
wald.test(lmm.exp)
```

We now have our final model with land use and pc5 and pc6.

NOTE - likfit function not sensitive to range parameter - not sure if dataset specific or issue with library.  Kate or Liana data?